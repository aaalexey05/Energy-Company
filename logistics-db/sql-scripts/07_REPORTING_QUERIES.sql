
-- ═══════════════════════════════════════════════════════════════════════════════
-- 07_REPORTING_QUERIES.sql 
-- ═══════════════════════════════════════════════════════════════════════════════
\c logistics_5nf;

-- 1. KPI (Работает 100%)
SELECT 
    TO_CHAR(дата_создания, 'YYYY-MM') AS месяц,
    COUNT(*) AS заказов,
    COUNT(*) FILTER (WHERE ид_статус = 6) AS доставлено
FROM грузы
GROUP BY 1 ORDER BY 1 DESC;

-- 2. ТОП КЛИЕНТОВ (Работает 100%)
SELECT 
    k.название,
    COUNT(g.ид_груз) as заказов
FROM клиенты k
JOIN грузы g ON k.ид_клиент = g.ид_клиент
GROUP BY k.название
ORDER BY 2 DESC
LIMIT 10;

-- 3. СТАТИСТИКА ПО ВОДИТЕЛЯМ (Работает 100%)
SELECT 
    v.фамилия,
    COUNT(ts.ид_средство) as машин
FROM водители v
JOIN транспортные_средства ts ON v.ид_водитель = ts.ид_водитель
GROUP BY v.фамилия
ORDER BY 2 DESC;
